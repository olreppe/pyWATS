# Instruction Loading Rules - Auto-Discovery System

**Purpose:** Define how agents discover and load instruction overlays

**Priority:** P0 - MANDATORY for all agent operations

**Last Updated:** February 3, 2026

---

## ğŸ¯ Core Principle

**Truth Source Hierarchy:**
```
Explicit Instructions (Overlay Files)
    â†“
Code Patterns (When No Overlay Exists)
    â†“
Implicit Behavior (Last Resort)
```

**Goal:** Prevent code drift by making overlays the authoritative source of truth.

---

## ğŸ” Discovery Algorithm

### Step 1: Identify Context

```python
def identify_context(task: str, file_path: Path) -> dict:
    """Extract context from task description and file path."""
    
    context = {
        "task_keywords": extract_keywords(task),
        "file_path": file_path,
        "file_type": file_path.suffix,
        "directory": file_path.parent,
        "is_test": "test" in file_path.name or file_path.match("tests/**"),
        "is_doc": file_path.match("docs/**") or file_path.match("examples/**"),
        "is_project": file_path.match("projects/active/**"),
        "is_release": file_path.name in ["CHANGELOG.md", "pyproject.toml"],
    }
    
    return context
```

### Step 2: Load Context Overlays

```python
def load_context_overlays(task_keywords: List[str]) -> List[Path]:
    """Load overlays based on task keywords."""
    
    overlays = []
    keyword_map = {
        ("doc", "example", "guide", "sphinx", "rst"): ".docs_instructions.md",
        ("test", "pytest", "fixture", "mock"): ".test_instructions.md",
        ("release", "changelog", "version", "deploy"): ".deployment_instructions.md",
        ("project", "milestone", "planning"): "projects/.agent_instructions.md",
    }
    
    for keywords, overlay_path in keyword_map.items():
        if any(kw in task_keywords for kw in keywords):
            overlays.append(Path(overlay_path))
    
    return overlays
```

### Step 3: Load File Path Overlays

```python
def load_file_path_overlays(file_path: Path) -> List[Path]:
    """Load overlays based on file location."""
    
    overlays = []
    path_map = {
        "docs/**": ".docs_instructions.md",
        "examples/**": ".docs_instructions.md",
        "tests/**": ".test_instructions.md",
        "projects/active/**": "projects/.agent_instructions.md",
    }
    
    for pattern, overlay_path in path_map.items():
        if file_path.match(pattern):
            overlays.append(Path(overlay_path))
    
    # Special files
    if file_path.name in ["CHANGELOG.md", "pyproject.toml"]:
        overlays.append(Path(".deployment_instructions.md"))
    
    return overlays
```

### Step 4: Walk Directory Tree

```python
def load_directory_overlays(file_path: Path) -> List[Path]:
    """Walk up directory tree looking for .agent_instructions.md."""
    
    overlays = []
    current_dir = file_path.parent
    repo_root = find_git_root(file_path)
    
    while current_dir >= repo_root:
        overlay = current_dir / ".agent_instructions.md"
        if overlay.exists():
            overlays.append(overlay)
        current_dir = current_dir.parent
    
    # Reverse so child directories override parents
    return list(reversed(overlays))
```

### Step 5: Combine and Deduplicate

```python
def load_all_instructions(task: str, file_path: Path) -> List[Path]:
    """
    Load all applicable instruction files.
    
    Order: Base â†’ Context â†’ File Path â†’ Directory (most specific last).
    """
    context = identify_context(task, file_path)
    instructions = []
    
    # 1. Base (always)
    instructions.append(Path(".github/copilot-instructions.md"))
    
    # 2. Context overlays
    instructions.extend(load_context_overlays(context["task_keywords"]))
    
    # 3. File path overlays
    instructions.extend(load_file_path_overlays(file_path))
    
    # 4. Directory overlays
    instructions.extend(load_directory_overlays(file_path))
    
    # Deduplicate while preserving order
    seen = set()
    unique_instructions = []
    for path in instructions:
        if path not in seen:
            seen.add(path)
            unique_instructions.append(path)
    
    return unique_instructions
```

---

## ğŸ“‹ Loading Examples

### Example 1: Simple Documentation Task

```
Task: "Add examples to the logging guide"
File: docs/guides/logging.md

Step 1: Identify context
  - Keywords: ["examples", "logging", "guide"]
  - File path: docs/guides/logging.md
  - Is doc: True

Step 2: Load context overlays
  - "examples" â†’ .docs_instructions.md

Step 3: Load file path overlays
  - docs/** â†’ .docs_instructions.md (already loaded)

Step 4: Walk directory tree
  - docs/guides/.agent_instructions.md (not found)
  - docs/.agent_instructions.md (not found)

Result:
  1. .github/copilot-instructions.md
  2. .docs_instructions.md

Announcement:
  "Loading instruction overlays:
   - .docs_instructions.md (P0 - type-safe documentation)
  
  Proceeding with type-safe documentation standards..."
```

### Example 2: Domain Service Test

```
Task: "Write tests for report query filtering"
File: tests/domains/report/test_service.py

Step 1: Identify context
  - Keywords: ["tests", "report", "query", "filtering"]
  - File path: tests/domains/report/test_service.py
  - Is test: True

Step 2: Load context overlays
  - "tests" â†’ .test_instructions.md

Step 3: Load file path overlays
  - tests/** â†’ .test_instructions.md (already loaded)

Step 4: Walk directory tree
  - tests/domains/report/.agent_instructions.md (not found)
  - tests/domains/.agent_instructions.md (FOUND!)
  - tests/.agent_instructions.md (not found)

Result:
  1. .github/copilot-instructions.md
  2. .test_instructions.md
  3. tests/domains/.agent_instructions.md

Announcement:
  "Loading instruction overlays:
   - .test_instructions.md (P0 - type-safe tests)
   - tests/domains/.agent_instructions.md (P2 - domain test patterns)
  
  Proceeding with combined instruction set..."
```

### Example 3: Multiple Contexts

```
Task: "Add domain service with tests and documentation examples"
File: src/pywats/domains/analytics/service.py

Step 1: Identify context
  - Keywords: ["domain", "service", "tests", "documentation", "examples"]
  - File path: src/pywats/domains/analytics/service.py

Step 2: Load context overlays
  - "tests" â†’ .test_instructions.md
  - "documentation", "examples" â†’ .docs_instructions.md

Step 3: Load file path overlays
  - (no pattern matches for src/pywats/domains/)

Step 4: Walk directory tree
  - src/pywats/domains/analytics/.agent_instructions.md (not found)
  - src/pywats/domains/.agent_instructions.md (FOUND!)
  - src/pywats/.agent_instructions.md (not found)
  - src/.agent_instructions.md (not found)

Result:
  1. .github/copilot-instructions.md
  2. .test_instructions.md
  3. .docs_instructions.md
  4. src/pywats/domains/.agent_instructions.md

Announcement:
  "Loading instruction overlays:
   - .test_instructions.md (P0 - type-safe tests)
   - .docs_instructions.md (P0 - type-safe documentation)
   - src/pywats/domains/.agent_instructions.md (P2 - domain service patterns)
  
  This task involves multiple contexts. Applying combined instruction set with priority resolution..."
```

---

## ğŸ¯ Priority Resolution

When overlays conflict, use priority system:

### Priority Levels

**P0 - MANDATORY:** Cannot be overridden
- `.docs_instructions.md` (type safety)
- `.test_instructions.md` (type safety)
- `.security_instructions.md` (future)

**P1 - REQUIRED:** Should not be overridden without justification
- `.deployment_instructions.md` (release standards)
- `projects/.agent_instructions.md` (project structure)
- `.model_instructions.md` (future)

**P2 - RECOMMENDED:** Can be overridden by higher priority
- Directory-specific `.agent_instructions.md` files
- Domain/feature-specific patterns

### Resolution Rules

```python
def resolve_conflict(instructions: List[Instruction]) -> Instruction:
    """
    When multiple overlays provide conflicting guidance, use priority.
    
    Rules:
    1. P0 always wins (type safety is non-negotiable)
    2. P1 wins over P2
    3. Same priority: More specific (directory) wins over general (root)
    4. Same specificity: Later in load order wins
    """
    
    # Sort by priority (P0 first), then specificity
    sorted_instructions = sorted(
        instructions,
        key=lambda i: (i.priority, i.specificity),
        reverse=False  # P0 = 0 comes first
    )
    
    return sorted_instructions[0]  # Highest priority wins
```

### Example Conflict

```
Task: "Create model with factory helper"
Overlays loaded:
  1. .test_instructions.md: "Use real models, not dicts" (P0)
  2. tests/domains/.agent_instructions.md: "Factories can return dicts for speed" (P2)

Conflict: Should factory return dict or model?
Resolution: P0 wins â†’ Factory must return real model
Reasoning: Type safety (P0) cannot be compromised for performance (P2)

Agent Action:
  "Conflict detected between overlays.
   Resolving in favor of .test_instructions.md (P0).
   Factory will return typed model instance."
```

---

## âœ… Agent Checklist (Before Starting Work)

**MANDATORY steps before any code generation:**

- [ ] **Parse task** - Extract keywords and identify intent
- [ ] **Identify file** - Determine target file path
- [ ] **Load base** - Read `.github/copilot-instructions.md`
- [ ] **Load context** - Based on task keywords
- [ ] **Load file path** - Based on target location
- [ ] **Walk tree** - Check all parent directories
- [ ] **Deduplicate** - Remove duplicate overlays
- [ ] **Resolve conflicts** - Apply priority rules if needed
- [ ] **Announce** - State loaded overlays to user
- [ ] **Validate understanding** - Confirm instruction compliance plan

---

## ğŸš« Common Mistakes

### Mistake 1: Skipping Directory Walk

```
âŒ WRONG:
  "Working on tests/domains/report/test_service.py
   Loading .test_instructions.md only"

âœ… CORRECT:
  "Working on tests/domains/report/test_service.py
   Checking directory tree for overlays...
   Found: tests/domains/.agent_instructions.md
   Loading: .test_instructions.md + tests/domains/.agent_instructions.md"
```

### Mistake 2: Not Announcing Overlays

```
âŒ WRONG:
  [Agent silently loads overlays and starts work]

âœ… CORRECT:
  "Loading instruction overlays:
   - .docs_instructions.md (P0)
   - .test_instructions.md (P0)
  Proceeding with type-safe standards..."
```

### Mistake 3: Ignoring Priority

```
âŒ WRONG:
  "Directory overlay says use dicts, so I'll use dicts"

âœ… CORRECT:
  "Directory overlay (P2) conflicts with .test_instructions.md (P0).
   Resolving in favor of P0: using typed models."
```

### Mistake 4: Not Deduplicating

```
âŒ WRONG:
  Loading:
    1. .docs_instructions.md (from keywords)
    2. .docs_instructions.md (from file path)
    3. .docs_instructions.md (loaded again)

âœ… CORRECT:
  Loading:
    1. .docs_instructions.md (deduplicated)
```

---

## ğŸ“ Creating Directory Overlays

### When to Create

**Create directory-specific overlay when:**
- âœ… Pattern applies to all files in directory
- âœ… Pattern is specific to that domain/feature
- âœ… Pattern doesn't belong in root overlays
- âœ… Multiple files in directory share same needs

**Don't create when:**
- âŒ Pattern applies project-wide (use root overlay)
- âŒ Pattern is one-off for single file
- âŒ Pattern conflicts with P0 rules

### Where to Create

```
src/pywats/domains/.agent_instructions.md        # Domain service patterns
src/pywats/models/.agent_instructions.md         # Model standards
src/pywats_client/converters/.agent_instructions.md  # Converter patterns
tests/domains/.agent_instructions.md             # Domain test patterns
tests/integration/.agent_instructions.md         # Integration test patterns
```

### Template

```markdown
# [Directory] Agent Instructions - [Priority]

**Context:** Working in [directory path]
**Priority:** P[0-2] - [MANDATORY/REQUIRED/RECOMMENDED]
**Applies To:** All files in [directory]

---

## ğŸ¯ Directory-Specific Patterns

[Patterns specific to this directory]

---

## âœ… Validation

[How to verify compliance]

---

## ğŸ”— Related Overlays

- Inherits from: [parent overlays]
- Extends: [which aspects]
- Conflicts with: [if any - should be P2 only]
```

---

## ğŸ”„ Maintenance

### When to Update Loading Rules

- New overlay priority level added
- New file path patterns emerge
- Discovery algorithm needs optimization
- Agent behavior shows gaps

### Audit Schedule

- **Weekly:** Review agent announcements for missed overlays
- **Monthly:** Check if new directories need overlays
- **Per release:** Validate overlay compliance metrics

---

**Remember:** The loading algorithm is the **bridge** between instruction truth and code generation. Keep it simple, explicit, and auditable.
