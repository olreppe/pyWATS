# Instruction Manifest - Context Loading System

**Purpose:** Central registry of context-specific instruction overlays for agents

**Last Updated:** February 3, 2026

---

## ğŸ“š How This Works

When working on different parts of the codebase, agents should **automatically load** additional instructions relevant to that context. This ensures consistency and enforces standards across different layers.

### Agent Workflow

```plaintext
1. Agent receives task
2. Agent identifies context from file paths/task type
3. Agent loads base instructions (.github/copilot-instructions.md)
4. Agent loads relevant overlay(s) from this manifest
5. Agent proceeds with combined instruction set
```

---

## ğŸ—ºï¸ Instruction Overlays

### Core Overlays (Active)

| Overlay File | Load When Working On | Priority | Status |
|-------------|---------------------|----------|--------|
| `.source_code_instructions.md` | `src/` (API, client, events) | **P0 - MANDATORY** | âœ… Active |
| `.docs_instructions.md` | `docs/`, `examples/`, docstrings | **P0 - MANDATORY** | âœ… Active |
| `.test_instructions.md` | `tests/`, writing tests | **P0 - MANDATORY** | âœ… Active |
| `projects/.agent_instructions.md` | `projects/active/` | **P1 - REQUIRED** | âœ… Active |
| `.deployment_instructions.md` | Releases, CHANGELOG, version bumps | **P1 - REQUIRED** | âœ… Active |
| `.domain_instructions.md` | `src/pywats/domains/` | **P2 - RECOMMENDED** | ğŸ’¡ Planned |

### Specialized Overlays (Planned)

| Overlay File | Load When Working On | Priority | Status |
|-------------|---------------------|----------|--------|
| `.model_instructions.md` | `src/pywats/models/` | **P1 - REQUIRED** | ğŸ’¡ Planned |
| `.api_instructions.md` | API design, endpoints | **P2 - RECOMMENDED** | ğŸ’¡ Planned |
| `.client_instructions.md` | `src/pywats_client/` | **P2 - RECOMMENDED** | ğŸ’¡ Planned |
| `.converter_instructions.md` | `src/pywats_client/converters/` | **P2 - RECOMMENDED** | ğŸ’¡ Planned |
| `.security_instructions.md` | Auth, credentials, secrets | **P0 - MANDATORY** | ğŸ’¡ Planned |

---

## ğŸ“‹ Overlay Details

### 1. Documentation Instructions
**File:** `.docs_instructions.md`  
**Load When:**
- Creating/editing files in `docs/`
- Creating/editing files in `examples/`
- Writing docstrings in source code (LOAD WITH .source_code_instructions.md)
- Adding code examples anywhere

**Key Requirements:**
- All code must be type-safe (no `dict`, `Any` returns)
- All function signatures verified against source
- All examples validated with mypy
- Enums required for known values
- Complete imports mandatory

**Enforcement:** Zero tolerance - no exceptions

---

### 3. Testing Instructions
**File:** `.test_instructions.md`  
**Load When:**
- Writing new tests
- Refactoring test code
- Fixing test failures
- Adding test coverage

**Key Requirements:**
- Type-safe test fixtures (no Mock() without spec)
- Type-safe test data (no dicts for models)
- Descriptive test names
- Proper mocking patterns
- All test functions â†’ None return type

**Enforcement:** Zero tolerance - same as source code

---

### 4. Project Management Instructions
**File:** `projects/.agent_instructions.md`  
**Load When:**
- Creating new projects in `projects/active/`
- Updating project status
- Closing/archiving projects

**Key Requirements:**
- 4-file structure (README, ANALYSIS, PLAN, PROGRESS, TODO)
- Real-time progress updates
- Todo marking (ğŸš§ before, âœ… after)
- Completion checklist

**Enforcement:** Required for all project work

---

### 5. Deployment Instructions
**File:** `.deployment_instructions.md`  
**Load When:**
- Updating CHANGELOG
- Bumping versions
- Creating releases
- Pre-release validation
- Documentation of breaking changes

**Key Requirements:**
- CHANGELOG format enforcement (Keep a Changelog)
- Version numbering rules (Semantic Versioning)
- Pre-release checklist (mypy, tests, docs)
- Migration guide requirements (breaking changes)
- **Internal endpoint risk disclosure** (pre-releases)

**Enforcement:** Required for all release PRs

---

### 6. Domain Service Instructions
**File:** `.domain_instructions.md` ğŸ’¡ PLANNED  
**Load When:**
- Creating/modifying domain services
- Adding new endpoints
- Refactoring domain logic

**Planned Requirements:**
- Domain service patterns
- Async/sync variants
- Error handling standards
- Model usage patterns
- Cache integration

---

## ğŸ¯ Usage Examples

### Example 1: Creating Documentation

```markdown
User: "Create Sphinx docs for the logging API"

Agent thinks:
1. Task involves docs/ directory
2. Load .docs_instructions.md
3. Apply type safety rules
4. Validate all examples

Agent says: "I'll create the Sphinx docs following .docs_instructions.md type safety requirements..."
```

### Example 2: Creating a Test

```markdown
User: "Add tests for the new feature"

Agent thinks:
1. Task involves tests/ directory
2. Load .test_instructions.md
3. Apply testing patterns
4. Ensure type-safe fixtures

Agent says: "I'll add tests following the testing standards..."
```

### Example 3: Preparing Release

```markdown
User: "Update CHANGELOG for release"

Agent thinks:
1. Task involves release/deployment
2. Load .deployment_instructions.md
3. Apply CHANGELOG format
4. Include endpoint risk disclosure if pre-release

Agent says: "I'll update CHANGELOG with the required sections and include the internal endpoint risk disclosure..."
```

### Example 4: Multiple Contexts

```markdown
User: "Add a new domain service with tests and examples"

Agent thinks:
1. Domain service â†’ .domain_instructions.md
2. Tests â†’ .test_instructions.md
3. Examples â†’ .docs_instructions.md
4. Load all three overlays

Agent says: "I'll implement this following domain, testing, and documentation standards..."
```

---

## ğŸ”„ Auto-Loading System (Combined Approach)

### Loading Algorithm

When working on a file, agents should load instructions in this order:

```python
def load_instructions(current_file: Path, task_description: str) -> List[Path]:
    """
    Combined context + directory overlay loading.
    Returns list ordered from general â†’ specific (later = higher priority).
    """
    instructions = []
    
    # 1. BASE: Always load
    instructions.append(".github/copilot-instructions.md")
    
    # 2. CONTEXT: Based on task type (from keywords)
    if any(word in task_description.lower() for word in ["source", "api", "client", "service", "model"]):
        instructions.append(".source_code_instructions.md")
    
    if any(word in task_description.lower() for word in ["doc", "example", "guide", "sphinx", "rst"]):
        instructions.append(".docs_instructions.md")
    
    if any(word in task_description.lower() for word in ["test", "pytest", "fixture"]):
        instructions.append(".test_instructions.md")
    
    if any(word in task_description.lower() for word in ["release", "changelog", "version", "deploy"]):
        instructions.append(".deployment_instructions.md")
    
    if any(word in task_description.lower() for word in ["project", "milestone", "planning"]):
        instructions.append("projects/.agent_instructions.md")
    
    # 3. FILE PATH: Based on file location
    if current_file.match("src/**"):
        if ".source_code_instructions.md" not in instructions:
            instructions.append(".source_code_instructions.md")
    
    if current_file.match("docs/**") or current_file.match("examples/**"):
        if ".docs_instructions.md" not in instructions:
            instructions.append(".docs_instructions.md")
    
    if current_file.match("tests/**"):
        if ".test_instructions.md" not in instructions:
            instructions.append(".test_instructions.md")
    
    if current_file.match("projects/active/**"):
        if "projects/.agent_instructions.md" not in instructions:
            instructions.append("projects/.agent_instructions.md")
    
    if current_file.name == "CHANGELOG.md" or current_file.name == "pyproject.toml":
        if ".deployment_instructions.md" not in instructions:
            instructions.append(".deployment_instructions.md")
    
    # 4. DIRECTORY WALK: Look for .agent_instructions.md up the tree
    current_dir = current_file.parent
    repo_root = find_git_root(current_file)
    directory_overlays = []
    
    while current_dir >= repo_root:
        overlay = current_dir / ".agent_instructions.md"
        if overlay.exists():
            directory_overlays.insert(0, overlay)  # Prepend (child â†’ parent)
        current_dir = current_dir.parent
    
    # Add directory overlays (most specific last)
    instructions.extend(reversed(directory_overlays))
    
src/**/*.py                 â†’ .source_code_instructions.md (P0 - MOST CRITICAL!)
    return instructions
```

### File Path Patterns

**Root-Level Context Overlays:**
```plaintext
docs/**/*.rst               â†’ .docs_instructions.md
docs/**/*.md                â†’ .docs_instructions.md
examples/**/*.py            â†’ .docs_instructions.md
tests/**/*.py               â†’ .test_instructions.md
CHANGELOG.md                â†’ .deployment_instructions.md
pyproject.toml (version)    â†’ .deployment_instructions.md
projects/active/**/*        â†’ projects/.agent_instructions.md
```

**Directory-Specific Overlays (Walk Up Tree):**
```plaintext
Working on: src/pywats/domains/report/service.py

Check for (in order):
1. src/pywats/domains/report/.agent_instructions.md
2. src/pywats/domains/.agent_instructions.md
3. src/pywats/.agent_instructions.md
4. src/.agent_instructions.md

Load all found (child overrides parent)
```

### Task Keywords

`implement", "create service", "add model" â†’ .source_code_instructions.md
"create documentation"      â†’ .docs_instructions.md
"add example"               â†’ .docs_instructions.md
"write tests"               â†’ .test_instructions.md
"release"                   â†’ .deployment_instructions.md
"update changelog"          â†’ .deployment_instructions.md
"new domain service"        â†’ .source_code_instructions.md + .deployment_instructions.md
"new domain service"        â†’ .domain_instructions.md
"new project"               â†’ projects/.agent_instructions.md
```

### Agent Workflow Example

```
Task: "Add tests for the new report query feature with examples"

Step 1: Parse task
  - Keywords: "tests" â†’ Load .test_instructions.md
  - Keywords: "examples" â†’ Load .docs_instructions.md

Step 2: Check file path (tests/domains/report/test_service.py)
  - Match: tests/** â†’ .test_instructions.md (already loaded)

Step 3: Walk directory tree
  - Check: tests/domains/report/.agent_instructions.md (not found)
  - Check: tests/domains/.agent_instructions.md (found!)
  - Check: tests/.agent_instructions.md (not found)

Step 4: Load order
  1. .github/copilot-instructions.md (base)
  2. .test_instructions.md (context)
  3. .docs_instructions.md (context)
  4. tests/domains/.agent_instructions.md (directory)

Step 5: Agent announces
  "Loading instruction overlays for this task:
   - .test_instructions.md (P0 - type-safe tests)
   - .docs_instructions.md (P0 - type-safe examples)
   - tests/domains/.agent_instructions.md (P2 - domain test patterns)
  
  Proceeding with combined instruction set..."
```

---

## ğŸš¨ Priority System
 (block commits/deploys)
- `.source_code_instructions.md` (type safety in production code - MOST CRITICAL)
**P0 - MANDATORY:** No exceptions, violations are critical errors
- `.docs_instructions.md` (type safety in docs)
- `.test_instructions.md` (type safety in tests)
- `.security_instructions.md` (when implemented)

**P1 - REQUIRED:** Should always be followed
- `projects/.agent_instructions.md` (project structure)
- `.deployment_instructions.md` (release process)
- `.model_instructions.md` (when implemented)

**P2 - RECOMMENDED:** Best practices, flexible when needed
- `.domain_instructions.md` (patterns, not rules)
- `.api_instructions.md` (guidelines)
- `.client_instructions.md` (guidelines)

---

## ğŸ“ Creating New Overlays

### Template Structure

```markdown
# [Context Name] Instructions - MANDATORY/REQUIRED/RECOMMENDED

**Context:** When working on [specific area]
**Priority:** P[0-2] - [Level]

---

## ğŸš¨ CRITICAL RULES - NO EXCEPTIONS

[P0 rules that must never be violated]

---

## ğŸ“‹ REQUIRED PATTERNS

[P1 rules that should always be followed]

---

## âœ… RECOMMENDED PRACTICES

[P2 guidelines and best practices]

---

## ğŸ” Validation Workflow

[How to verify compliance]

---

## ğŸš« Common Anti-Patterns

[Mistakes to avoid]

---

## âœ… Enforcement Strategy

[How this is enforced]
```

### Checklist for New Overlay

- [ ] Clear scope definition
- [ ] Priority level assigned
- [ ] Auto-load triggers defined
- [ ] Validation workflow included
- [ ] Examples of correct/incorrect usage
- [ ] Added to this manifest
- [ ] Referenced in `.github/copilot-instructions.md`

---

## ğŸ”§ Maintenance

### Review Schedule
- **Monthly:** Review overlay effectiveness
- **Per Release:** Update with new patterns
- **As Needed:** Add new overlays for emerging needs

### Update Process
1. Identify need for new overlay
2. Draft overlay using template
3. Add to manifest
4. Update `.github/copilot-instructions.md`
5. Announce to team
6. Monitor compliance

---

## ğŸ“Š Metrics

**Target Compliance:**
- P0 overlays: 100% compliance
- P1 overlays: 95%+ compliance
- P2 overlays: 80%+ compliance

**Measurement:**
- Code review violations
- CI/CD validation failures
- Manual audits

---

## ğŸ“ Agent Training

**When starting work, agents should:**

1. âœ… Identify task context
2. âœ… Check this manifest for applicable overlays
3. âœ… Load all relevant instruction files
4. âœ… Apply combined instruction set
5. âœ… Validate compliance before committing

**Agents must explicitly state which overlays are loaded:**

```
"I'm loading .docs_instructions.md and .test_instructions.md for this task..."
```

---

**Next Steps:**
1. Create `.test_instructions.md` (Priority: High)
2. Create `.deployment_instructions.md` (Priority: High)
3. Create `.model_instructions.md` (Priority: Medium)
4. Update `.github/copilot-instructions.md` to reference manifest
