# Deployment & Release Standards - REQUIRED

**Context:** When preparing releases, updating CHANGELOG, or bumping versions

**Priority:** P1 - Required for all release activities

---

## üö® CRITICAL - Internal Endpoint Risk Disclosure

### ‚ö†Ô∏è MANDATORY for All Pre-Releases and Early Releases (< v1.0.0)

**EVERY pre-release and beta release MUST include this disclosure:**

```markdown
## ‚ö†Ô∏è Internal Endpoint Dependency

**IMPORTANT:** This version connects to an internal WATS server endpoint that may change without notice.

### Risk Level
- **Pre-release (0.x.xbX):** HIGH - Endpoint may change at any time
- **Beta (0.x.x):** MEDIUM - Endpoint relatively stable but not guaranteed
- **Stable (1.0.0+):** LOW - Endpoint changes will follow versioning policy

### What This Means
If the internal endpoint structure changes:
- API calls may fail with authentication errors
- Data retrieval may return unexpected formats
- Some features may become temporarily unavailable

### What To Do If This Happens
1. **Check for Updates:** Run `pip install --upgrade pywats`
2. **Verify Version:** Ensure you have the latest pre-release/beta
3. **Contact Support:** If issues persist, contact the development team
4. **Rollback:** If critical, rollback to last working version

### Mitigation
We are actively working toward:
- [ ] Versioned API endpoints (target: v0.3.0)
- [ ] Backward compatibility guarantees (target: v1.0.0)
- [ ] Deprecation notices for endpoint changes
- [ ] Migration guides for breaking changes

For more details, see [Internal Endpoint Risk Documentation](docs/INTERNAL_ENDPOINT_RISK.md).
```

### When to Include This Warning

**MUST Include:**
- All `0.x.xbX` (pre-release) versions
- All `0.x.x` (beta) versions
- Release notes on GitHub
- `README.md` installation section
- `docs/getting-started.md`

**Can Remove:**
- When versioned endpoints implemented (v0.3.0+)
- When reaching stable v1.0.0
- When backward compatibility guaranteed

---

## üìã CHANGELOG Standards

### Format: Keep a Changelog

**Location:** `CHANGELOG.md` (repository root)

**Structure:**
```markdown
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/),
and this project adheres to [Semantic Versioning](https://semver.org/).

## [Unreleased]

### Added
- New features

### Changed
- Changes to existing functionality

### Deprecated
- Soon-to-be removed features

### Removed
- Removed features

### Fixed
- Bug fixes

### Security
- Security fixes

### Improved
- Performance, docs, or quality improvements

## [0.2.0-beta.1] - 2026-02-03

‚ö†Ô∏è **Internal Endpoint Dependency** - See top of file for details.

### Added
- **Feature Name**: Brief description
  ...
```

### Category Guidelines

**Added:** New features users can now use
```markdown
### Added
- **Logging Infrastructure**: Unified logging across API and client
  - **Core Logging** (pywats.core.logging): configure_logging(), FileRotatingHandler, LoggingContext
  - **Client Logging** (pywats_client.core.logging): setup_client_logging() for pywats.log
  - **ConversionLog**: Per-conversion detailed logging with JSON line format
  - **Examples**: 3+ runnable examples in examples/converters/
  - **Tests**: 63 comprehensive tests (97% pass rate)
```

**Changed:** Modifications to existing behavior
```markdown
### Changed
- **Report Model**: Added optional `temperature` field
  - Migration: Existing code continues to work
  - Breaking: None
```

**Deprecated:** Features that will be removed
```markdown
### Deprecated
- **Legacy Auth**: Token-based auth deprecated in favor of API keys
  - Will be removed in: v0.4.0
  - Migration guide: docs/guides/migration.md
```

**Removed:** Features that were removed
```markdown
### Removed
- **Legacy API**: Removed deprecated `get_reports_v1()` method
  - Removed in: v0.3.0
  - Replacement: Use `query_reports()` instead
```

**Fixed:** Bug fixes
```markdown
### Fixed
- **Report Query**: Fixed pagination error when querying >1000 reports
  - Issue: #123
  - Impact: High - affected all large queries
```

**Security:** Security-related changes
```markdown
### Security
- **Authentication**: Fixed credential leakage in debug logs
  - Severity: HIGH
  - CVE: CVE-2026-XXXXX (if applicable)
```

**Improved:** Performance, docs, or quality
```markdown
### Improved
- **Performance**: Report queries 3x faster with optimized caching
  - Benchmark: 100ms ‚Üí 33ms for 100-report queries
  - Impact: All query operations
```

### Entry Format

**Template:**
```markdown
### [Category]
- **[Component/Feature Name]**: Brief description
  - **Detail 1**: Specifics with examples
  - **Detail 2**: More specifics
  - **Breaking Changes**: If any (MUST be explicit)
  - **Migration**: How to adapt (if breaking)
  - **Tests**: Number of tests added (if significant)
  - **Docs**: Link to new documentation
```

**Example:**
```markdown
### Added
- **ConversionLog**: Per-conversion detailed logging
  - **JSON Line Format**: One JSON object per line for crash safety
  - **Auto-Flush**: Immediate write after each log entry
  - **Methods**: step(), warning(), error(), finalize()
  - **Integration**: Optional parameter in ConverterArguments
  - **Tests**: 20 new tests in tests/client/test_conversion_log.py
  - **Docs**: See docs/guides/logging.md and examples/converters/logging_example_converter.py
```

---

## üî¢ Version Numbering (Semantic Versioning)

### Format: MAJOR.MINOR.PATCH[-prerelease]

**Examples:**
- `0.1.0` - Initial beta release
- `0.2.0-beta.1` - Second beta, first pre-release
- `0.2.0-beta.2` - Second beta, second pre-release
- `0.2.0` - Second beta, stable
- `1.0.0` - First stable release

### When to Bump

**MAJOR (1.0.0 ‚Üí 2.0.0):**
- Breaking changes to public API
- Removal of deprecated features
- Incompatible endpoint changes
- Migration required

**MINOR (0.1.0 ‚Üí 0.2.0):**
- New features (backward compatible)
- New domain services
- Significant enhancements
- Deprecations (but not removals)

**PATCH (0.2.0 ‚Üí 0.2.1):**
- Bug fixes
- Documentation improvements
- Performance optimizations
- Internal refactoring

**Pre-release (0.2.0 ‚Üí 0.2.0-beta.1):**
- Testing before stable release
- Feature complete but needs validation
- Breaking changes acceptable in pre-releases

---

## üìù Release Checklist

### Pre-Release Validation

```bash
# Run comprehensive checks
.\scripts\pre_release_check.ps1
```

**Manual Checklist:**

- [ ] **Tests:** All tests passing (`pytest`)
- [ ] **Type Checking:** Minimize errors (`mypy src/pywats --strict`)
- [ ] **Linting:** No major issues (`flake8 src/pywats`)
- [ ] **Examples:** 3-5 key examples run successfully
- [ ] **CHANGELOG:** `[Unreleased]` section complete
- [ ] **CHANGELOG:** Internal endpoint warning included (if pre-release)
- [ ] **Version:** Updated in `pyproject.toml`
- [ ] **Version:** Updated in `docs/api/conf.py`
- [ ] **Documentation:** Sphinx docs regenerated
- [ ] **README:** Endpoint warning visible (if pre-release)
- [ ] **Migration Guide:** Created if breaking changes

### CHANGELOG Update Process

1. **Collect Changes:**
   ```bash
   # Review commits since last release
   git log v0.1.0..HEAD --oneline
   ```

2. **Categorize:**
   - Group by Added/Changed/Fixed/etc.
   - Write user-facing descriptions
   - Include file paths where helpful

3. **Add Entry:**
   ```markdown
   ## [0.2.0-beta.1] - 2026-02-03
   
   ‚ö†Ô∏è **Internal Endpoint Dependency** - This version may break if internal endpoint changes. See [docs/INTERNAL_ENDPOINT_RISK.md] for details.
   
   ### Added
   - ...
   ```

4. **Verify:**
   - [ ] All significant changes included
   - [ ] User-facing language (not technical jargon)
   - [ ] Breaking changes explicitly marked
   - [ ] Migration paths provided
   - [ ] Endpoint warning included

### Version Bump Process

1. **Update `pyproject.toml`:**
   ```toml
   [project]
   name = "pywats"
   version = "0.2.0-beta.1"
   ```

2. **Update `docs/api/conf.py`:**
   ```python
   version = '0.2.0'
   release = '0.2.0-beta.1'
   ```

3. **Commit:**
   ```bash
   git add pyproject.toml docs/api/conf.py CHANGELOG.md
   git commit -m "chore(release): Bump version to 0.2.0-beta.1"
   ```

4. **Tag:**
   ```bash
   git tag -a v0.2.0-beta.1 -m "Release v0.2.0-beta.1"
   git push origin v0.2.0-beta.1
   ```

---

## üìÑ Release Notes

### GitHub Release Template

```markdown
## pyWATS v0.2.0-beta.1

### ‚ö†Ô∏è Internal Endpoint Dependency

**IMPORTANT:** This pre-release version connects to an internal WATS server endpoint that may change without notice.

**What this means:** If the endpoint changes, API calls may fail. To resolve:
1. Update to latest version: `pip install --upgrade pywats`
2. Check release notes for migration guides
3. Contact support if issues persist

See [Internal Endpoint Risk Documentation](docs/INTERNAL_ENDPOINT_RISK.md) for full details.

---

### üéâ Highlights

[Key features/improvements in this release]

### üìã Full Changelog

[Copy relevant sections from CHANGELOG.md]

### üì¶ Installation

```bash
pip install pywats==0.2.0b1
```

### üìö Documentation

- [Getting Started](docs/getting-started.md)
- [API Reference](https://your-docs-site/api/)
- [Examples](examples/)

### üêõ Known Issues

- [List any known issues]

### üîÑ Migration Guide

[If breaking changes, provide migration steps]
```

---

## üö® Breaking Changes Policy

### Communication

**MUST do for breaking changes:**

1. **Document in CHANGELOG** under `### Changed` or `### Removed`
2. **Mark with üö® BREAKING** prefix
3. **Provide migration guide**
4. **Deprecate first** (if possible)
5. **Include in release notes**

**Example:**
```markdown
### Changed
- üö® **BREAKING: Report.status field type changed**
  - **Old:** `str` (e.g., "passed", "failed")
  - **New:** `ReportStatus` enum
  - **Reason:** Type safety and consistency
  - **Migration:**
    ```python
    # Old code
    if report.status == "passed":
        ...
    
    # New code
    from pywats.models import ReportStatus
    if report.status == ReportStatus.PASSED:
        ...
    ```
  - **Automatic Migration:** Run `python scripts/migrate_status_enum.py`
  - **Deprecation:** Old string values deprecated in v0.1.0, removed in v0.2.0
```

### Deprecation Process

1. **Mark as deprecated** (add warning)
2. **Document replacement** in docstring
3. **Wait 1-2 releases** before removal
4. **Provide migration tools** if complex

```python
import warnings

def get_reports_v1() -> List[dict]:
    """
    Get reports (DEPRECATED).
    
    .. deprecated:: 0.2.0
       Use :func:`query_reports` instead.
    """
    warnings.warn(
        "get_reports_v1() is deprecated, use query_reports()",
        DeprecationWarning,
        stacklevel=2
    )
    # Old implementation...
```

---

## üìä Release Metrics

### Track in CHANGELOG

- **Tests:** Pass rate, total count
- **Coverage:** Overall percentage
- **Type Errors:** Count (target: <20)
- **Performance:** If significantly improved
- **Documentation:** New guides/examples added

**Example:**
```markdown
### Metrics
- **Tests:** 416 passing, 12 skipped (97% pass rate)
- **Coverage:** 89% overall
- **Type Errors:** 16 (down from 740, 98% improvement)
- **Documentation:** 8 new guides, 137 examples
```

---

## üîê Security Releases

### Security Vulnerability Disclosure

```markdown
### Security
- **Authentication Bypass (HIGH)**: Fixed session token validation
  - **CVE:** CVE-2026-XXXXX
  - **Severity:** HIGH (CVSS 8.5)
  - **Affected Versions:** 0.1.0 - 0.1.9
  - **Fixed In:** 0.1.10
  - **Impact:** Unauthenticated users could access restricted endpoints
  - **Mitigation:** Upgrade to 0.1.10 immediately
  - **Credit:** Reported by Jane Doe
  - **Disclosure:** 30-day responsible disclosure followed
```

### Rapid Security Release

1. **Fix immediately** in private branch
2. **Test thoroughly**
3. **Prepare patch release**
4. **Notify affected users** before public disclosure
5. **Release with detailed security advisory**

---

## ‚úÖ Validation Commands

```bash
# Full pre-release check
.\scripts\pre_release_check.ps1

# Individual checks
pytest                                    # All tests pass
mypy src/pywats --strict                  # Type checking
flake8 src/pywats --max-line-length=120   # Linting
python -m build                           # Build succeeds
python -m twine check dist/*              # Package valid

# Documentation
cd docs && make html                      # Sphinx builds
# Check for warnings in output
```

---

**Last Updated:** February 3, 2026  
**Applies To:** All release activities, CHANGELOG updates, version bumps  
**Enforcement:** Required for PR approval on release-related changes
