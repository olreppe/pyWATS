# Build Installers Workflow
#
# Builds platform-specific installers and standalone executables.
# Triggered on release or manual dispatch.
#
# Outputs:
# - Windows MSI installer
# - macOS PKG installer + DMG
# - Linux DEB package
# - Linux RPM package
# - Standalone executables (all platforms)
# - Docker images (multi-arch)

name: Build Installers

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (leave empty for current)'
        required: false
        type: string
      platforms:
        description: 'Platforms to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - windows
          - macos
          - linux
          - docker

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================================================
  # Prepare version and metadata
  # ==========================================================================
  prepare:
    name: Prepare Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Get version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

  # ==========================================================================
  # Windows MSI Installer
  # ==========================================================================
  build-windows:
    name: Build Windows MSI
    runs-on: windows-latest
    needs: prepare
    if: inputs.platforms == 'all' || inputs.platforms == 'windows' || github.event_name == 'release'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -e ".[client]"
          pip install cx_Freeze pyinstaller
      
      - name: Build frozen application
        run: |
          cd deployment/windows
          python build_frozen.py --all
        continue-on-error: true
      
      - name: Build standalone executable
        run: |
          cd deployment/standalone
          python build_standalone.py --gui --onedir
      
      - name: Package as ZIP
        run: |
          cd dist
          Compress-Archive -Path "pyWATS Client" -DestinationPath "pywats-client-${{ needs.prepare.outputs.version }}-windows-x64.zip"
        shell: pwsh
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            dist/*.msi
            dist/*.zip
          if-no-files-found: warn

  # ==========================================================================
  # macOS Installer
  # ==========================================================================
  build-macos:
    name: Build macOS Installer
    runs-on: macos-latest
    needs: prepare
    if: inputs.platforms == 'all' || inputs.platforms == 'macos' || github.event_name == 'release'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -e ".[client]"
          pip install pyinstaller
      
      - name: Build standalone executable
        run: |
          cd deployment/standalone
          python build_standalone.py --gui --onedir
      
      - name: Create DMG
        run: |
          # Create DMG using hdiutil
          cd dist
          hdiutil create -srcfolder "pyWATS Client.app" \
            -volname "pyWATS Client" \
            -fs HFS+ -fsargs "-c c=64,a=16,e=16" \
            -format UDZO \
            "pywats-client-${{ needs.prepare.outputs.version }}-macos.dmg"
        continue-on-error: true
      
      - name: Create ZIP fallback
        run: |
          cd dist
          zip -r "pywats-client-${{ needs.prepare.outputs.version }}-macos.zip" "pyWATS Client.app" || true
          zip -r "pywats-client-${{ needs.prepare.outputs.version }}-macos.zip" "pyWATS Client" || true
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: |
            dist/*.dmg
            dist/*.pkg
            dist/*.zip
          if-no-files-found: warn

  # ==========================================================================
  # Linux Packages
  # ==========================================================================
  build-linux:
    name: Build Linux Packages
    runs-on: ubuntu-22.04
    needs: prepare
    if: inputs.platforms == 'all' || inputs.platforms == 'linux' || github.event_name == 'release'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -e ".[client-headless]"
          pip install pyinstaller
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dh-python
      
      - name: Build standalone executable
        run: |
          cd deployment/standalone
          python build_standalone.py --headless --onefile
      
      - name: Build AppImage
        run: |
          # Download appimagetool
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          sudo mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool
          
          # Build
          cd deployment/standalone
          python build_standalone.py --headless --appimage
        continue-on-error: true
      
      - name: Package standalone
        run: |
          cd dist
          tar czf "pywats-client-${{ needs.prepare.outputs.version }}-linux-x64.tar.gz" pywats-client 2>/dev/null || true
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            dist/*.tar.gz
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
          if-no-files-found: warn

  # ==========================================================================
  # Docker Images
  # ==========================================================================
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: prepare
    if: inputs.platforms == 'all' || inputs.platforms == 'docker' || github.event_name == 'release'
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployment/docker/Dockerfile
          target: api
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}-api:${{ needs.prepare.outputs.version }}
            ghcr.io/${{ github.repository }}-api:latest
      
      - name: Build and push Client image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployment/docker/Dockerfile
          target: client-headless
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}-client:${{ needs.prepare.outputs.version }}
            ghcr.io/${{ github.repository }}-client:latest

  # ==========================================================================
  # Upload to Release
  # ==========================================================================
  upload-release:
    name: Upload to Release
    runs-on: ubuntu-latest
    needs: [prepare, build-windows, build-macos, build-linux]
    if: github.event_name == 'release'
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: List artifacts
        run: find artifacts -type f -ls
      
      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.msi
            artifacts/**/*.pkg
            artifacts/**/*.dmg
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
            artifacts/**/*.AppImage
          fail_on_unmatched_files: false
