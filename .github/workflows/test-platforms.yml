name: Platform Tests

# Cross-platform testing matrix for pyWATS
# Tests on Windows, Ubuntu, macOS, and RHEL-compatible Linux

on:
  push:
    branches: [main, release, 'feature/**']
  pull_request:
    branches: [main]

jobs:
  # ==========================================================================
  # Core platform tests - Windows, Ubuntu, macOS
  # ==========================================================================
  test-platforms:
    name: Test ${{ matrix.os }} / Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04, windows-latest, macos-latest]
        python-version: ['3.10', '3.11', '3.12']
        exclude:
          # Reduce matrix size - skip some combinations
          - os: macos-latest
            python-version: '3.10'
          - os: ubuntu-24.04
            python-version: '3.10'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          pytest tests/ -v --tb=short -x -m "not server"
        env:
          WATS_BASE_URL: "https://demo.wats.com"
          WATS_AUTH_TOKEN: "dGVzdDp0ZXN0"

      - name: Test diagnose command
        run: |
          python -m pywats_client diagnose --json
        continue-on-error: true

  # ==========================================================================
  # RHEL/Rocky Linux tests in container
  # ==========================================================================
  test-rhel:
    name: Test Rocky Linux 9 / Python 3.11
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9
    
    steps:
      - name: Install Git
        run: dnf install -y git

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python and dependencies
        run: |
          dnf install -y python3.11 python3.11-pip python3.11-devel
          python3.11 -m pip install --upgrade pip

      - name: Install pyWATS
        run: |
          python3.11 -m pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          python3.11 -m pytest tests/ -v --tb=short -x -m "not server"
        env:
          WATS_BASE_URL: "https://demo.wats.com"
          WATS_AUTH_TOKEN: "dGVzdDp0ZXN0"

      - name: Test diagnose command
        run: |
          python3.11 -m pywats_client diagnose --json
        continue-on-error: true

      - name: Validate SELinux policy syntax
        run: |
          dnf install -y selinux-policy-devel
          cd deployment/selinux/
          checkmodule -M -m -o pywats.mod pywats.te
          echo "SELinux policy compiles successfully"
        continue-on-error: true

  # ==========================================================================
  # Package validation (lint only, no actual build)
  # ==========================================================================
  validate-packages:
    name: Validate Package Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install validation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck lintian

      - name: Validate shell scripts
        run: |
          shellcheck deployment/debian/postinst deployment/debian/prerm deployment/debian/postrm || true
          shellcheck deployment/selinux/install-selinux.sh || true
          shellcheck deployment/packer/files/first-boot-setup.sh || true

      - name: Validate DEB control files
        run: |
          # Check for required fields
          grep -q "^Package:" deployment/debian/control
          grep -q "^Version:" deployment/debian/control
          grep -q "^Architecture:" deployment/debian/control
          grep -q "^Depends:" deployment/debian/control
          echo "DEB control file valid"

      - name: Validate RPM spec file (syntax only)
        run: |
          docker run --rm -v $PWD:/src fedora:39 \
            bash -c "dnf install -y rpmlint 2>/dev/null && rpmlint /src/deployment/rpm/pywats.spec" || true

      - name: Validate systemd units (INI syntax)
        run: |
          python3 -c "
          import configparser
          for f in ['deployment/debian/pywats-client.service', 'deployment/rpm/pywats-client.service', 'deployment/packer/files/pywats-client.service']:
              try:
                  cp = configparser.ConfigParser()
                  cp.read(f)
                  print(f'{f}: Valid INI syntax')
              except Exception as e:
                  print(f'{f}: INVALID - {e}')
          "

  # ==========================================================================
  # Docker multi-architecture validation
  # ==========================================================================
  validate-docker:
    name: Validate Docker Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (native arch only)
        run: |
          docker build -t pywats-test -f deployment/docker/Dockerfile .

      - name: Test Docker image
        run: |
          docker run --rm pywats-test python -c "import pywats; print('pyWATS import OK')"

      - name: Test health endpoint in Docker
        run: |
          docker run -d --name pywats-health -p 8080:8080 pywats-test
          sleep 5
          curl -f http://localhost:8080/health || echo "Health endpoint not available (expected if service not started)"
          docker stop pywats-health || true
          docker rm pywats-health || true
        continue-on-error: true

  # ==========================================================================
  # ARM64 emulation test (slower, but validates cross-platform)
  # ==========================================================================
  test-arm64:
    name: Test ARM64 (QEMU emulation)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ARM64 image
        run: |
          docker buildx build --platform linux/arm64 -t pywats-arm64 -f deployment/docker/Dockerfile --load .

      - name: Test ARM64 image
        run: |
          docker run --rm --platform linux/arm64 pywats-arm64 python -c "import pywats; print('ARM64 OK')"

  # ==========================================================================
  # DEB Package Build and Test
  # ==========================================================================
  build-deb:
    name: Build DEB Package
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dh-python python3-all python3-setuptools python3-pip

      - name: Prepare source for packaging
        run: |
          # Create source tarball structure
          VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "Building version: $VERSION"
          
          # Update debian changelog with version
          sed -i "s/^pywats-client (.*)/pywats-client ($VERSION-1)/" deployment/debian/changelog

      - name: Build DEB package
        run: |
          # Copy debian folder to project root (debhelper expects it there)
          cp -r deployment/debian .
          
          # Build the package
          dpkg-buildpackage -b -uc -us || echo "DEB build completed with warnings"
        continue-on-error: true

      - name: Test DEB installation (dry-run)
        run: |
          # Check if DEB was created
          ls -la ../*.deb 2>/dev/null || echo "DEB package not created (expected if build had issues)"
          
          # If created, test installation in clean container
          if ls ../*.deb 1>/dev/null 2>&1; then
            docker run --rm -v $(pwd)/..:/debs ubuntu:22.04 bash -c "
              apt-get update
              dpkg -i /debs/*.deb || apt-get -f install -y
              python3 -c 'import pywats; print(\"DEB install test: OK\")'
            " || echo "Container test skipped"
          fi
        continue-on-error: true

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: ../*.deb
          if-no-files-found: warn

  # ==========================================================================
  # RPM Package Build and Test
  # ==========================================================================
  build-rpm:
    name: Build RPM Package
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    container:
      image: rockylinux:9
    
    steps:
      - name: Install Git and build tools
        run: |
          dnf install -y git rpm-build python3-devel python3-setuptools python3-pip rpmdevtools

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup RPM build environment
        run: |
          rpmdev-setuptree
          
          # Get version from pyproject.toml
          VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "Building version: $VERSION"
          
          # Update spec file version
          sed -i "s/^Version:.*/Version:        $VERSION/" deployment/rpm/pywats.spec

      - name: Create source tarball
        run: |
          VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          mkdir -p ~/rpmbuild/SOURCES
          tar czf ~/rpmbuild/SOURCES/pywats-client-$VERSION.tar.gz \
            --transform "s,^,pywats-client-$VERSION/," \
            src/ pyproject.toml README.md LICENSE MANIFEST.in

      - name: Build RPM package
        run: |
          rpmbuild -bb deployment/rpm/pywats.spec || echo "RPM build completed with warnings"
        continue-on-error: true

      - name: List built packages
        run: |
          ls -la ~/rpmbuild/RPMS/noarch/ 2>/dev/null || echo "No RPM packages built"

      - name: Test RPM installation (dry-run)
        run: |
          if ls ~/rpmbuild/RPMS/noarch/*.rpm 1>/dev/null 2>&1; then
            rpm -ivh --test ~/rpmbuild/RPMS/noarch/*.rpm || echo "RPM test install completed"
          fi
        continue-on-error: true

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: ~/rpmbuild/RPMS/noarch/*.rpm
          if-no-files-found: warn

  # ==========================================================================
  # systemd Service Integration Test
  # ==========================================================================
  test-systemd:
    name: Test systemd Integration
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pyWATS
        run: |
          pip install -e ".[client-headless]"

      - name: Create service user and directories
        run: |
          sudo useradd -r -s /sbin/nologin pywats || true
          sudo mkdir -p /etc/pywats /var/lib/pywats /var/log/pywats
          sudo chown pywats:pywats /var/lib/pywats /var/log/pywats

      - name: Install systemd unit
        run: |
          sudo cp deployment/debian/pywats-client.service /etc/systemd/system/
          sudo systemctl daemon-reload

      - name: Create minimal config
        run: |
          echo '{"server": {"url": "https://demo.wats.com", "token": "test"}, "health": {"enabled": true, "port": 8080}}' | sudo tee /etc/pywats/config.json
          sudo chown pywats:pywats /etc/pywats/config.json

      - name: Test service start
        run: |
          sudo systemctl start pywats-client || echo "Service start may fail without valid token"
          sleep 3
          sudo systemctl status pywats-client || true
        continue-on-error: true

      - name: Check service logs
        run: |
          sudo journalctl -u pywats-client --no-pager -n 20 || true

      - name: Test health endpoint
        run: |
          curl -s http://localhost:8080/health || echo "Health endpoint not responding (expected without valid config)"
        continue-on-error: true

      - name: Cleanup
        run: |
          sudo systemctl stop pywats-client || true
          sudo systemctl disable pywats-client || true

  # ==========================================================================
  # Windows Service Test (dry-run, no admin)
  # ==========================================================================
  test-windows-service:
    name: Test Windows Service (dry-run)
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pyWATS with service support
        run: |
          pip install -e ".[client]"
        shell: pwsh

      - name: Test pywin32 import
        run: |
          python -c "import win32serviceutil; print('pywin32 OK')"
        shell: pwsh

      - name: Test service module
        run: |
          python -c "from pywats_client.service import windows_service; print('Windows service module OK')"
        shell: pwsh
        continue-on-error: true

      - name: Test service help
        run: |
          python -m pywats_client --help
        shell: pwsh
        continue-on-error: true
